name: Zenchef slot watcher

on:
  schedule:
    - cron: "*/15 * * * *" # toutes les 15 minutes (UTC) [web:167]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run check
        id: check
        env:
          ZEN_RID: "362852"
          ZEN_PAX: "2"
          ZEN_MONTHS_AHEAD: "4"
          DEBUG: "1"
        run: |
          python check_zenchef.py

      - name: Job summary
        if: always()
        run: |
          echo "## Zenchef watcher result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- RestaurantId: 362852" >> $GITHUB_STEP_SUMMARY
          echo "- Pax: 2" >> $GITHUB_STEP_SUMMARY
          echo "- Status: **${{ steps.check.outputs.status }}**" >> $GITHUB_STEP_SUMMARY
          echo "- Reason: ${{ steps.check.outputs.reason }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.check.outputs.details_json }}' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Debug" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo '${{ steps.check.outputs.debug_json }}' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Create issue if available
        if: steps.check.outputs.available == '1'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -sS -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            https://api.github.com/repos/${{ github.repository }}/issues \
            -d "{\"title\":\"Zenchef: créneau détecté\",\"body\":\"Pax=2\\nReason=${{ steps.check.outputs.reason }}\\nDetails=${{ steps.check.outputs.details_json }}\\n\\nVa vérifier: https://bookings.zenchef.com/results?rid=362852\"}"
